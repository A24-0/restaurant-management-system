# Система управления рестораном - Обновление

## Основные изменения

### 1. Расширение времени работы ресторана до 23:00

**Изменённые файлы:** `table.cs`

- Ресторан теперь работает с **9:00 до 23:00** (вместо 9:00-18:00)
- Обновлён метод `InitializeSchedule()` для генерации слотов до 22:00-23:00
- Обновлён вывод информации о столе: отображается "Расписание (09:00 – 23:00)"

```csharp
// До:  for (int hour = 9; hour <= 18; hour++)
// После: for (int hour = 9; hour <= 22; hour++)
```

### 2. Корректная взаимосвязь между бронью, заказом и столиком

#### Изменения в `booking.cs`

**Новые возможности:**
- Добавлено свойство `LinkedOrder` - связь брони с заказом
- Проверка времени работы ресторана при создании брони (9:00-23:00)
- Автоматическое добавление брони в расписание стола
- Защита от отмены брони с активным заказом

```csharp
// Связь с заказом
public Order LinkedOrder { get; set; }

// Метод для связывания заказа с бронью
public void LinkOrder(Order order)
{
    if (LinkedOrder != null && !LinkedOrder.IsClosed)
    {
        throw new InvalidOperationException($"К этой брони уже привязан активный заказ #{LinkedOrder.OrderId}");
    }
    LinkedOrder = order;
}
```

**Обновленный метод `CancelBooking()`:**
- Проверяет наличие активного связанного заказа
- Запрещает отмену брони, если к ней привязан незакрытый заказ

**Обновленный метод `DisplayAllBookings()`:**
- Отображает статус связанного заказа (создан/не создан, активен/закрыт)

#### Изменения в `order.cs`

**Новые возможности:**
- Добавлено свойство `LinkedBooking` - обязательная связь с бронью
- Заказ можно создать **ТОЛЬКО** при наличии активной брони
- Конструктор и метод `CreateOrder()` требуют объект `Booking`

```csharp
// Связь с бронью
public Booking LinkedBooking { get; set; }

public static Order CreateOrder(int orderId, int tableId, int waiterId, Booking booking, string comment = "")
{
    if (booking == null)
    {
        throw new InvalidOperationException("Для создания заказа необходима активная бронь!");
    }

    // Проверяем, что бронь активна на данный момент
    DateTime now = DateTime.Now;
    if (!(booking.TimeStart <= now && booking.TimeEnd > now))
    {
        throw new InvalidOperationException(
            $"Бронь не активна в данный момент. Время брони: {booking.TimeStart:HH:mm} - {booking.TimeEnd:HH:mm}");
    }

    // Проверяем совпадение столиков
    if (booking.Table.ID != tableId)
    {
        throw new InvalidOperationException(
            $"Столик в заказе ({tableId}) не соответствует столику в брони ({booking.Table.ID})");
    }

    var order = new Order(orderId, tableId, waiterId, booking, comment);
    
    // Связываем бронь с заказом
    booking.LinkOrder(order);
    
    return order;
}
```

**Обновленный метод `ShowInfo()`:**
- Отображает информацию о клиенте из связанной брони
- Показывает время брони

**Обновленный метод `PrintReceipt()`:**
- Включает данные клиента из брони (имя, телефон)

#### Изменения в `program.cs`

**Обновленный метод `CreateOrderInteractive()`:**
- Проверяет наличие активной брони перед созданием заказа
- Отображает информацию о найденной брони
- Передает объект `Booking` в метод `Order.CreateOrder()`

```csharp
// Проверка наличия активной брони
if (!Booking.HasActiveBookingForTable(tableId))
{
    ConsoleTheme.WriteError("❌ Нельзя создать заказ: на столик нет активной брони!");
    ConsoleTheme.WriteInfo("Сначала создайте бронирование на этот столик в Системе бронирования.");
    return;
}

// Получаем активную бронь
var booking = Booking.GetActiveBookingForTable(tableId);
ConsoleTheme.WriteSuccess($"✓ Найдена активная бронь: {booking.ClientName} ({booking.Phone})");

// Создаем заказ с бронью
var order = Order.CreateOrder(_nextOrderId++, tableId, waiterId, booking, comment);
```

## Логика работы системы

### Правильный порядок действий:

1. **Создание брони** (`Booking`)
   - Клиент бронирует столик на определенное время (9:00-23:00)
   - Бронь привязывается к конкретному столику
   - Столик помечается как занятый в указанное время

2. **Создание заказа** (`Order`)
   - Заказ можно создать **ТОЛЬКО** если есть активная бронь на столик
   - При создании заказ автоматически связывается с бронью
   - В заказе отображаются данные клиента из брони

3. **Добавление блюд в заказ**
   - Блюда добавляются в уже созданный заказ
   - Рассчитывается общая стоимость

4. **Закрытие заказа**
   - Заказ закрывается с фиксацией времени
   - Можно вывести чек с полной информацией

5. **Отмена брони**
   - Бронь можно отменить только если нет активного заказа
   - При отмене брони столик освобождается

## Защита от ошибок

### Система предотвращает:
- ✅ Создание заказа без брони
- ✅ Создание заказа для неактивной брони
- ✅ Создание заказа на столик, не соответствующий брони
- ✅ Отмену брони с активным заказом
- ✅ Бронирование вне часов работы ресторана (9:00-23:00)
- ✅ Пересечение бронирований на одном столике

## Пример использования

```
1. Клиент звонит и бронирует столик №3 на 19:00-21:00
   → Создается Booking для стола #3

2. Клиент приходит в 19:05
   → Официант создает Order для стола #3
   → Система автоматически находит активную бронь
   → Заказ связывается с бронью

3. Клиент делает заказ
   → Блюда добавляются в Order

4. Клиент заканчивает ужин в 20:45
   → Официант закрывает заказ
   → Печатается чек с данными клиента

5. После ухода клиента
   → Бронь можно отменить (заказ уже закрыт)
```

## Технические детали

### Связи между классами:

```
Table (Столик)
  ↓
Booking (Бронь)
  ↓ LinkedOrder
Order (Заказ)
  ↓ OrderItems
Dish (Блюдо)
```

### Ключевые проверки:

1. **При создании брони:**
   - Время в диапазоне 9:00-23:00
   - Отсутствие пересечений с другими бронями
   - Наличие столика

2. **При создании заказа:**
   - Наличие активной брони
   - Активность брони в текущий момент
   - Соответствие столика

3. **При отмене брони:**
   - Отсутствие активного заказа

## Компиляция и запуск

```bash
dotnet build restaurant-management-system.csproj
dotnet run
```

## Автор изменений

Обновлено: 2025-11-10